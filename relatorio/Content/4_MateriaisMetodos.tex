\chapter{Materiais e Métodos}
\label{Materiais}
\hspace{0,5cm}

  Neste seção irá se discursar sobre os materiais e métodos utilizados no desenvolvimento do projeto \emph{R3V}. Os materiais englobam todos os dispositivos físicos e produtos lógicos (bibliotecas de código, etc) utilizados no desenvolvimento do projeto proposto. Os métodos apresentam como e por meio de qual técnica alguns processos do sistema foram desenvolvidos, abstraindo o produto e focando na maneira com que foi implementado.

  % Descrição clara dos procedimentos e dos materiais adotados para o desenvolvimento do trabalho (sem resultados) - incluindo sua adequação ao trabalho.

  % Tem que responder às perguntas:
  % -está com um tamanho adequado (proporcional) à monografia?
  % -há informação suficiente e clara sobre os materiais e sobre os métodos  adotados?

  % Não há necessidade de reproduzir (copiar) as obras que embasam o trabalho e sim colocar o suficiente para o entendimento do trabalho e citar as referências.


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
\section{Materiais}
\hspace{0,5cm}
  A seguir são apresentados os materiais relevantes para o projeto proposto (\emph{R3V}), sendo eles: placa de desenvolvimento Intel Galileo, \emph{smarthphone Android}, IPCam (câmera controlada por rede) e Flask (servidor python).

  \subsection{Intel Galileo} % rebs

    A placa de desenvolvimento Intel\textsuperscript{\textregistered} Galileo (figura \ref{galileo}), projetada e vendida pela Intel\textsuperscript{\textregistered}, foi criada com base no processador Intel\textsuperscript{\textregistered} Quark SoC X1000 de aplicação com o intuito de ser compatível com os \emph{shields} de Arduino.\\
    O processador provê para o usuário final uma arquitetura de 32 bits e \emph{clock} de 400 MHz, conectores Ethernet 10/100, PCI-Express \emph{mini-card}, USB 2.0, USB cliente (usado para programação) e botões de \emph{reboot} e \emph{reset}.\\
    Como apresentado anteriormente, a placa possui diversas interfaces de conexão para viabilizar a comunicação com um computador, outro Arduino e até outros microcontroladores.\\
    A Galileo suporta programação através da IDE do Arduino como também a utilização de um sistema operacional embarcado instalado em seu \emph{hardware}.

    \begin{figure}[H]
    \centering
    \includegraphics[scale=0.6]{./Resources/galileo.png}
    \caption{Imagem da placa de desenvolvimento Galileo - visão frontal (\emph{Galileo Front}), visão de trás (\emph{Galileo Back}) (visto em: http://www.intel.com/content/www/us/en/embedded/products/galileo/galileo-g1-datasheet.html)}
    \label{galileo}
   \end{figure}

   A sua aplicação dentro do projeto desenvolvido é prover um \emph{webservice} REST através do \emph{framework} Flask.

    %http://www.intel.com/content/www/us/en/embedded/products/galileo/galileo-g1-datasheet.html

  \subsection{Smartphone Android} % davi
    Atualmente, os \emph{smartphones} Android vem sendo uma ótima plataforma
    para desenvolvimento. Já integrado com diversos sensores e dispositivos de
    entrada e saída; como acelerômetro, GPS, câmera, microfone, sistema de som,
    tela, entre outros; além de disponibilizar uma sólida ferramenta de
    desenvolvimento, a Android SDK.

    Dos \emph{hardwares} providos pelo \emph{smartphone} foi utilizado na aplicação
    os sensores inerciais, a fim de obter os angulos de euler da orientação do
    dispositivo; a tela, para a exibição da interface gráfica e a
    conexão \emph{wifi}, para comunicação com a Intel Galileo. A forma como estes
    recursos foram utilizados será abordada na exposição da aplicação Android.

  \subsection{IPCam} % rebs


    Para o \emph{streaming} de video, uma câmera IP foi utilizada afim de disponibilizar um serviço em rede e desacoplar o dispositivo do servidor (placa de desenvolvimento Intel\textsuperscript{\textregistered} Galileo). Este \emph{hardware} provê, através de um protocolo \emph{http}, um serviço que executa diversas operações através de \emph{scripts} CGI.\\
    As intertfaces CGI da câmera apresentam três níveis diferenciados de permissão, sendo eles: visitante, operador e administrador. A funcionalidade utilizada pelo projeto somente requisitou acesso de operador (usuário e senha fornecidos pelo professor).\\
    Além de serviços de video, a câmera em questão possui \emph{scripts} para monitoramento, detecção de movimento, movimentação da mesma e diversos outros.\\
    O projeto R3V utilizou-se de dois \emph{scripts}, chamados: \emph{decoder\_control.cgi} e \emph{videostream.cgi}.\\
    O \emph{script videostream.cgi} realiza a captura e envio do video através da rede para o cliente, enquanto que o \emph{decoder\_control.cgi} controla a movimentação da câmera em sua base. Abaixo (tabela \ref{comandos_ipcam}) se destaca os comandos de movimentação que foram utilizados no projeto.

    \begin{table}[ht]
    \centering
    \caption{Comandos utilizados no projeto R3V da câmera IPCam FOSCAM}
    \begin{tabular}{|c|c|}
    \hline
    Comando & Descrição\\
    \hline
    $0$ & Move a câmera para baixo \\
    $2$ & Move a câmera para cima \\
    $4$ & Move a câmera para a esquerda \\
    $6$ & Move a câmera para a direita \\
    $25$ & Coloca a câmera no seu centro (implementação própria) \\
    $90$ & Move a câmera para a diagonal esquerda inferior \\
    $91$ & Move a câmera para a diagonal direita inferior \\
    $92$ & Move a câmera para a digonal esquerda superior \\
    $93$ & Move a câmera para a diagonal direita superior \\
    \hline
    \end{tabular}
    \label{comandos_ipcam}
    \end{table}

    Para mais informações sobre o funcionamento da câmera utilizada consulte o manual do fabricante: \cite{ipcam}.

  \subsection{Flask}
    % http://flask.pocoo.org/
    ``O Flask é um microframework para python, baseado no \emph{Werkzeug},
    \emph{Jinja2} e boas intenções'' \textbf{referência para página do flask}.
    Com o \emph{Flask} podemos facilmente criar um \emph{backend} para processar
    as requisições à Intel Galileo, implementando assim um \emph{WebService}
    REST.

    Para utilizarmos o Flask, atrelamos um método python a uma determinada URL.
    Assim conseguimos recuperar dados transmitidos através da requisição HTTP,
    processá-los e retornarmos uma resposta. Através do Flask, o R3V provê três
    serviços: \emph{streaming} de vídeo de uma câmera IP, movimentação desta
    câmera e \emph{dead reckoning} do movimento da câmera. A seguir abordamos
    melhor o provisionamento de cada um destes serviços.

    Através da URL \textless{}\emph{endereço\_da\_intel\_galileo}\textgreater
    /camstream/ provemos o serviço de \emph{streaming} de vídeo. Este endereço
    retorna um \emph{stream} MJPEG ouseja, uma sequência de imagens JPEG. Este
    serviço recupera as imagens da câmera pelo mesmo serviço de MJPEG. Desta
    forma ele atua somente como um \emph{proxy}, encapsulando o serviço de
    \emph{stream} de vídeo da própria câmera IP.

    Através da URL \textless{}\emph{endereço\_da\_intel\_galileo}\textgreater
    /camposition/cam\_step/?move=\textless{}direção\textgreater{} provemos o
    serviço de movimentação da câmera IP em passos de cinco graus. No parâmatro
    direção deve-se informar o código da direção que se deve atuar. As direções
    são mapeadas conforme a tabela \ref{tblDirectionCodes}.

    \begin{table}[h]
      \centering
      \caption{Código de direção para requisitar movimentação da câmera.}
      \begin{tabular}{|c|c|}
        \hline  Código  & Direção   \\  \hline
                0       & abaixo    \\  \hline
                2       & acima     \\  \hline
                4       & esquerda  \\  \hline
                6       & direita   \\  \hline
                90      & diagonal esquerda abaixo  \\  \hline
                91      & diagonal direita abaixo   \\  \hline
                92      & diagonal esquerda acima   \\  \hline
                93      & diagonal direita acima    \\  \hline
      \end{tabular}
      \label{tblDirectionCodes}
    \end{table}

    Através da URL \textless{}\emph{endereço\_da\_intel\_galileo}\textgreater
    /camposition/set\_zero/ inicializamos o sistema de \emph{dead reckoning} do
    movimento da câmera, tomando a posição atual da câmera como zero graus de
    rotação em torno do eixo $x$ e zero graus de rotação em torno do eixo $y$.

    Através da URL \textless{}\emph{endereço\_da\_intel\_galileo}\textgreater
    /camposition/?pitch=\textless{}x\textgreater{}\&yaw=\textless{}y\textgreater{}
    provemos o serviço de movimentação da câmera com \emph{dead reckoning} do
    movimento. No parâmetro $x$ deve-se atribuir qual a posição angular desejada
    em torno do eixo $x$. No parâmetro $y$ deve-se atribuir qual a posição
    angular desejada em torno do eixo $y$. O serviço de movimentação por \emph{
    dead reckoning} só aceita posições angulares para \emph{pitch} entre 80 e 
    -30 graus e posições angulares para \emph{yaw} entre 100 e -100 graus.

    Desta forma temos a Intel Galileo provendo os servições de \emph{streaming},
    \emph{movimentação} e \emph{dead reckoning} da posição de uma câmera IP.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
\section{Métodos} %rebs
\hspace{0,5cm}
Métodos utilizados no projeto.

  \subsection{MJPEG}
  % Idea: http://blog.miguelgrinberg.com/post/video-streaming-with-flask
  \subsection{\emph{Dead Reckoning}} % rebs
  \subsection{Applicação Cliente} %davi
    A aplicação cliente foi desenvolvida como um aplicativo Android. Para o
    desenvolvimento de aplicativos Android é feito o uso do Android SDK. Ele
    provê meios de criar interfaces gráficas, aplicativos com processamento
    paralelo, comunicação interprocesso, conexão com servidores HTTP, e muitas
    outras funcionalidades. Neste projeto nos interessa a criação de uma
    interface gráfica para utilizar o \emph{smartphone} no Google Cardboard, o
    acesso aos sensores inerciais (acelerômetro, giroscópio e magnetômetro) e a
    comunicação com servidores HTTP.

    Para a interface gráfica, o necessário é podermos exibir uma imagem em cada
    metade da tela, com o celular em orientação paisagem. Ambas as imagens deve
    ser a mesma, de forma a dar o aspecto tridimensional quando no \emph{
    cardboard}. Para nos beneficiarmos de algumas facilidades do \emph{Cardboard
    SDK}, discutidas adiante, foi necessário manter a interface de renderizador
    gráfico do \emph{Cardboard}, mas uma nova interface foi sobreposta sobre a
    padrão.

    O acesso aos sensores inerciais foi feito indiretamente através do \emph{
    Cardboard SDK}. Ela abstrai o cálculo dos ângulos de euler do dispositivo
    como uma requisição da direção de visão do usuário. Desta forma temos os
    ângulos ao redor dos eixos $x$ e $y$ sem termos que diretamente acessar os
    sensores inerciais e tratar suas leituras.

    Outro recurso do Android utilizado foi a comunicação com servidores HTTP. A
    comunicação entre o \emph{smartphone} Android e a Intel Galileo caracteriza
    o R3V como um sistema distribuído. Diz-se isto pois possuímos dois dispositivos
    computacionais, conectados pela internet e operando em conjunto através de
    troca de mensagens. Com informação trocada entre os dispositivos temos o
    \emph{streaming} de vídeo da Galileo para o \emph{smartphone} e o pedido de
    movimentação da câmera, do dispositivo móvel para o servidor, requisitando
    o mesmo posicionamento angular lado no cliente.

    Na recepção do \emph{streaming} de vídeo foi utilizada a classe MjpegInputStream.
    A classe foi reutilizada do projeto arduino-android-blueprints, de Marco Schwartz,
    mas a autoria da classe é desconhecida e esta é utilizada em diversos projetos.

    No comando de movimentação da câmera há dois tratamentos para evitar o uso
    abusivo da rede. Um dos tratamentos é por segmentação de movimento. Só é
    enviado um comando, do \emph{smartphone} para o servidor, se o movimento
    tiver pelo menos três graus de variação seja no eixo $x$ ou no eixo $y$.
    Outro método de redução de uso da rede é nunca enviar um comando com menos
    de 200 milisegundos de espaçamento do comando anterior. Desta forma reduzimos
    o uso de dados do dispositivo celular e evitamos de sobrecarregar o servidor
    com muitas requisições. Outro contato do dispositivo móvel com a Intel Galileo
    é na inicialização do aplicativo, onde requisita-se que o servidor zere as
    posições angulares da câmera, a fim de sincronizar o movimento do \emph{
    smartphone} com a câmera IP.
